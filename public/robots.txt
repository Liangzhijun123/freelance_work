import React, { useState, useRef, useEffect, useCallback, useLayoutEffect } from 'react';
import { Tree } from 'react-tree-graph';
import 'react-tree-graph/dist/style.css';
import rootNode from './Data';

const DEFAULT_DEPTH = 9;

const cloneWithDepth = (object, depth = DEFAULT_DEPTH) => {
  if (depth === -1) return undefined;
  if (typeof object !== 'object') return object;

  if (Array.isArray(object)) {
    return object
      .map((val) => cloneWithDepth(val, depth - 1))
      .filter((val) => val !== undefined);
  }

  const clone = {};

  for (const key in object) {
    if (typeof object[key] === 'object' && depth - 1 === -1) {
      continue;
    }

    const clonedValue = cloneWithDepth(object[key], depth - 1);

    if (clonedValue !== undefined) {
      clone[key] = clonedValue;
    }
  }

  return clone;
};
interface TreeNode {
  name: string;
  children?: TreeNode[];
}
const findNode = (key: string, node: TreeNode = rootNode, parentPath: string[] = []): { node: TreeNode; path: string[] } | undefined => {
  const path = [...parentPath, node.name];

  if (node.name === key) {
    return { node: cloneWithDepth(node), path };
  }

  if (Array.isArray(node.children)) {
    for (const child of node.children) {
      const found = findNode(key, child, path);
      if (found) return found;
    }
  }

  return undefined;
};


const useWindowInnerSize = () => {
  const [innerWidth, setInnerWidth] = useState(window.innerWidth);
  const [innerHeight, setInnerHeight] = useState(window.innerHeight);

  const handleResize = useCallback(() => {
    setInnerWidth(window.innerWidth);
    setInnerHeight(window.innerHeight);
  }, []);

  useEffect(() => {
    window.addEventListener('resize', handleResize);

    return () => window.removeEventListener('resize', handleResize);
  }, [handleResize]);

  return {
    innerWidth,
    innerHeight,
  };
};

const Data = () => {
  const [data, setData] = useState(cloneWithDepth(rootNode));
  const [path, setPath] = useState([rootNode.name]);
  const [canvasWidth, setCanvasWidth] = useState(0);
  const [canvasHeight, setCanvasHeight] = useState(0);
  const { innerWidth, innerHeight } = useWindowInnerSize();
  const canvasWrapper = useRef(null);

  const setCanvasSize = useCallback(() => {
    if (canvasWrapper.current) {
      const { clientWidth, clientHeight } = canvasWrapper.current;
      setCanvasWidth(clientWidth);
      setCanvasHeight(clientHeight);
    }
  }, []);
  
  useEffect(setCanvasSize, [setCanvasSize]);

  useLayoutEffect(() => {
    setCanvasWidth(0);
    setCanvasHeight(0);
  }, [innerWidth, innerHeight]);

  useEffect(() => {
    let isMounted = true;
  
    requestAnimationFrame(() => {
      if (isMounted) {
        setCanvasSize();
      }
    });
  
    return () => {
      isMounted = false;
    };
  }, [innerWidth, innerHeight, setCanvasSize]);
  

  const changeNode = (foundNode: { node: TreeNode; path: string[] } | undefined) => {
    if (foundNode) {
      setPath(foundNode.path);
      setData(foundNode.node);
    }
  };
  

  const handleClick = (_, key: string) => {
    const foundNode = findNode(key);
    changeNode(foundNode);
  };
  

  return (
    <div style={{ flexGrow: 1, display: 'flex', flexDirection: 'column' }}>
      <div>
        <div>
          {path.map((p) => (
            <button
              style={{
                margin: '0',
                border: 'none',
                outline: 'none',
                background: 'none',
                padding: '0 0.1rem',
                textDecoration: 'underline',
                cursor: data.name === p ? '' : 'pointer',
                color: data.name === p ? 'black' : 'blue',
              }}
              key={p}
              onClick={() => changeNode(findNode(p))}
            >
              {p}
            </button>
          ))}
        </div>
      </div>
      <div style={{ height: '500px' }}>
      <Tree
        data={rootNode}
        width={600}
        height={400}
        
        margins={{ top: 20, bottom: 10, left: 20, right: 200 }}
      />
    </div>
    </div>
  );
};

export default Data;
